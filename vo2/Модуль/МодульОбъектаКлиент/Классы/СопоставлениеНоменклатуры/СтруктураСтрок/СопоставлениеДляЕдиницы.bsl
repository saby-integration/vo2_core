
// Функция - создаёт строку сопоставления единицы
//
// Параметры:
//  ИдСБИС	 - 	 - 
//  ИмяСБИС	 - 	 - 
// 
// Возвращаемое значение:
//   - 
//
&НаКлиенте
Функция НовыйСопоставлениеДляЕдиницыКлиент() Экспорт
	
	Возврат Новый Структура("_класс, Коэффициент, ОКЕИ, Название, Ссылка, Владелец", "СопоставлениеДляЕдиницы", "1", "", "", "", "", "");

КонецФункции

&НаКлиенте
Функция СопоставлениеДляЕдиницыКлиент_Ключ(СопоставлениеДляЕдиницы) Экспорт
	
	Если ЗначениеЗаполнено(СопоставлениеДляЕдиницы.Ссылка) Тогда
		Возврат СопоставлениеДляЕдиницы.Ссылка;
	ИначеЕсли ЗначениеЗаполнено(СопоставлениеДляЕдиницы.ОКЕИ) Тогда
		Возврат СопоставлениеДляЕдиницы.ОКЕИ + "_" + СопоставлениеДляЕдиницы.Название;
	Иначе
		Возврат СопоставлениеДляЕдиницы.Название;
	КонецЕсли;
		
КонецФункции

&НаКлиенте
Функция СопоставлениеДляЕдиницыКлиент_Получить(СопоставлениеДляЕдиницы, КлючПоиска) Экспорт
	
	Если КлючПоиска = "Владелец" Тогда
		Если ЗначениеЗаполнено(СопоставлениеДляЕдиницы.Ссылка) Тогда
			// Если ссылка есть, то владелец не должен быть пустым. Прочерк, если в принципе нет.
			Попытка
				// Пока через Try, переделать на параметр от ини конфигурации
				СопоставлениеДляЕдиницы.Владелец = СопоставлениеДляЕдиницы.Ссылка.Владелец;
			Исключение
			КонецПопытки;
			ВидыСправочниковНоменклатуры = ПолучитьЗначениеПараметраСбис("ВидыСправочниковНоменклатуры");
			Если Не ЗначениеЗаполнено(СопоставлениеДляЕдиницы.Владелец)
					Или Не ЭтоСсылкаНаСправочникНоменклатурыНаСервереБезКонтекста(СопоставлениеДляЕдиницы.Владелец, ВидыСправочниковНоменклатуры) Тогда
				// Не удалось установить владельца. Вроде не должно быть ошибкой
				СопоставлениеДляЕдиницы.Владелец = "-";
			КонецЕсли;
		Иначе
			СопоставлениеДляЕдиницы.Владелец = "";
		КонецЕсли;
		Возврат СопоставлениеДляЕдиницы.Владелец;
	ИначеЕсли КлючПоиска = "Единица" Тогда
		Попытка
			КлючПараметра = "ЕдиницаИзмерения";
			СопоставлениеДляЕдиницы.Единица = СопоставлениеДляЕдиницыКлиент_ПолучитьПараметрНаСервере(СопоставлениеДляЕдиницы.Владелец, КлючПараметра);
		Исключение
			Возврат Неопределено;
		КонецПопытки;
	Иначе
		
		// Словили неожиданный ключ? Хреново, но ситуация исключительная, пока не обрабатываем
		Попытка
			Возврат СопоставлениеДляЕдиницы[КлючПоиска]; 
		Исключение 
			Возврат Неопределено;
		КонецПопытки;
		
	КонецЕсли;
	
	Возврат СопоставлениеДляЕдиницы[КлючПоиска];
	
КонецФункции

&НаКлиенте
Процедура СопоставлениеДляЕдиницыКлиент_Вставить(СопоставлениеДляЕдиницы, КлючВставить, ЗначениеВставить) Экспорт
	
	Перем КлючДобавитьВДанные, ЗначениеЗаполнить;
	
	Если		КлючВставить = "Ссылка" Тогда
		Если ЗначениеЗаполнено(ЗначениеВставить) Тогда
			
			СопоставлениеДляЕдиницы.Ссылка = ЗначениеВставить;
			
			// Если ссылка есть, то владелец не должен быть пустым. Прочерк, если в принципе нет.
			Попытка
				СопоставлениеДляЕдиницы.Владелец = ЗначениеВставить.Владелец;
			Исключение
			КонецПопытки;
			ВидыСправочниковНоменклатуры = ПолучитьЗначениеПараметраСбис("ВидыСправочниковНоменклатуры");
			Если НЕ ЗначениеЗаполнено(СопоставлениеДляЕдиницы.Владелец)
					Или Не ЭтоСсылкаНаСправочникНоменклатурыНаСервереБезКонтекста(СопоставлениеДляЕдиницы.Владелец, ВидыСправочниковНоменклатуры) Тогда
				// Не удалось установить владельца. Вроде не должно быть ошибкой
				СопоставлениеДляЕдиницы.Владелец = "-";
			КонецЕсли;
			
		Иначе
			
			СопоставлениеДляЕдиницы.Владелец = "";
			
		КонецЕсли;
	ИначеЕсли КлючВставить = "Владелец" Тогда
		 СопоставлениеДляЕдиницы.Владелец = ЗначениеВставить;
	ИначеЕсли	КлючВставить = "Название" Тогда
		
		Если ЗначениеЗаполнено(ЗначениеВставить) Тогда
			СопоставлениеДляЕдиницы.Название = ЗначениеВставить;
		Иначе
			СопоставлениеДляЕдиницы.Название = Строка(СопоставлениеДляЕдиницы.Ссылка);
		КонецЕсли;
		
	ИначеЕсли	КлючВставить = "Коэффициент" Тогда
		
		Если ЗначениеЗаполнено(ЗначениеВставить) Тогда
			СопоставлениеДляЕдиницы[КлючВставить] = ЗначениеВставить;
		Иначе
			СопоставлениеДляЕдиницы[КлючВставить] = "1";
		КонецЕсли;
		
	ИначеЕсли	СопоставлениеДляЕдиницы.Свойство(КлючВставить) Тогда
		
		СопоставлениеДляЕдиницы[КлючВставить] = ЗначениеВставить;
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СопоставлениеДляЕдиницыКлиент_Заполнить(СопоставлениеДляЕдиницы, Источник, КлючПоиска, ДопПараметры) Экспорт
	
	Перем КлючДобавитьВДанные, ЗначениеЗаполнить;
	
	Если Не ДопПараметры.Свойство("Ключ", КлючДобавитьВДанные) Тогда 
		КлючДобавитьВДанные = КлючПоиска;
	КонецЕсли;
	Если	Не	Источник.Свойство(КлючПоиска, ЗначениеЗаполнить)
		Или Не	ЗначениеЗаполнено(ЗначениеЗаполнить) Тогда
		Возврат;
	КонецЕсли;
	
	СопоставлениеДляЕдиницы.Вставить(КлючДобавитьВДанные, ЗначениеЗаполнить);
	
КонецПроцедуры

&НаКлиенте
Процедура СопоставлениеДляЕдиницыКлиент_Заполнить1С(СтрокаНоменклатуры1С, СопоставлениеЗаполнить) Экспорт
	
	Перем СЛокальнаяПеременная;
	
	Если		СопоставлениеЗаполнить.Свойство("ЕдИзмОрг", СЛокальнаяПеременная) Тогда
		// Наименование единицы измерения в старом формате
	ИначеЕсли	СопоставлениеЗаполнить.Свойство("ЕдИзм1С", СЛокальнаяПеременная) Тогда
		// Наименование единицы измерения в новом формате
	КонецЕсли;
	Если	ЗначениеЗаполнено(СЛокальнаяПеременная)
		И	СтрокаНоменклатуры1С.Единицы.Получить(СЛокальнаяПеременная) = Неопределено Тогда
		ЕдиницаСопоставление = НовыйСопоставлениеДляЕдиницыКлиент();
		СопоставлениеДляЕдиницыКлиент_Вставить(ЕдиницаСопоставление, "Ссылка", СЛокальнаяПеременная);
		СопоставлениеДляЕдиницыКлиент_Вставить(ЕдиницаСопоставление, "Владелец", СопоставлениеЗаполнить.Номенклатура); // Владелец у единицы должен быть заполнен всегда
	Иначе
		Возврат;
	КонецЕсли;
	
	Если	СопоставлениеЗаполнить.Свойство("ОКЕИ_1С", СЛокальнаяПеременная)
		И	ЗначениеЗаполнено(СЛокальнаяПеременная) Тогда
		СопоставлениеДляЕдиницыКлиент_Вставить(ЕдиницаСопоставление, "ОКЕИ", СЛокальнаяПеременная);
	КонецЕсли;
	
	Если		СопоставлениеЗаполнить.Свойство("Коэффициент",	СЛокальнаяПеременная) Тогда
		// Коэффициент в старом формате
	ИначеЕсли	СопоставлениеЗаполнить.Свойство("Коэффициент1С",	СЛокальнаяПеременная) Тогда
		// Коэффициент в новом формате
	КонецЕсли;
	Если ЗначениеЗаполнено(СЛокальнаяПеременная) Тогда
		СопоставлениеДляЕдиницыКлиент_Вставить(ЕдиницаСопоставление, "Коэффициент", СЛокальнаяПеременная);
	КонецЕсли;
	
	Если	СопоставлениеЗаполнить.Свойство("ЕдИзмНаименование1С",	СЛокальнаяПеременная)
		И	ЗначениеЗаполнено(СЛокальнаяПеременная) Тогда
		СопоставлениеДляЕдиницыКлиент_Вставить(ЕдиницаСопоставление, "Название", СЛокальнаяПеременная);
	Иначе
		СопоставлениеДляЕдиницыКлиент_Вставить(ЕдиницаСопоставление, "Название", Строка(ЕдиницаСопоставление.Ссылка));
	КонецЕсли;	
	
	ОписаниеНоменклатуры1СКлиент_Вставить(СтрокаНоменклатуры1С, "Единица", ЕдиницаСопоставление);

КонецПроцедуры

&НаКлиенте
Процедура СопоставлениеДляЕдиницыКлиент_ЗаполнитьСБИС(СтрокаСопоставленияСБИС, СопоставлениеЗаполнить) Экспорт
	
	Перем СЛокальнаяПеременная;
	
	ЕдиницаСопоставление = НовыйСопоставлениеДляЕдиницыКлиент();
	
	Если		СопоставлениеЗаполнить.Свойство("ЕдИзмОКЕИ", СЛокальнаяПеременная) Тогда 
		// ОКЕИ в старом формате вариант 1	
	ИначеЕсли	СопоставлениеЗаполнить.Свойство("ОКЕИ", СЛокальнаяПеременная) Тогда
		// ОКЕИ в старом формате вариант 2
	ИначеЕсли	СопоставлениеЗаполнить.Свойство("ЕдИзмОКЕИ_СБИС", СЛокальнаяПеременная) Тогда
		// ОКЕИ в новом формате вариант 1
	ИначеЕсли	СопоставлениеЗаполнить.Свойство("ОКЕИ_СБИС", СЛокальнаяПеременная) Тогда
		// ОКЕИ в новом формате вариант 2
	КонецЕсли;
	Если ЗначениеЗаполнено(СЛокальнаяПеременная) Тогда
		СопоставлениеДляЕдиницыКлиент_Вставить(ЕдиницаСопоставление, "ОКЕИ", СЛокальнаяПеременная);
	КонецЕсли;
	
	Если		СопоставлениеЗаполнить.Свойство("ЕдИзмНаименование",	СЛокальнаяПеременная) Тогда
		// Наименование единицы измерения в старом формате вариант 1
	ИначеЕсли 	СопоставлениеЗаполнить.Свойство("ЕдИзм",				СЛокальнаяПеременная) Тогда
		// Наименование единицы измерения в старом формате вариант 2
	ИначеЕсли	СопоставлениеЗаполнить.Свойство("ЕдИзмНаименованиеСБИС",СЛокальнаяПеременная) Тогда
		// Наименование единицы измерения в новом формате
	КонецЕсли;	
	Если ЗначениеЗаполнено(СЛокальнаяПеременная) Тогда
		СопоставлениеДляЕдиницыКлиент_Вставить(ЕдиницаСопоставление, "Название", СЛокальнаяПеременная);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ЕдиницаСопоставление.ОКЕИ) И Не ЗначениеЗаполнено(ЕдиницаСопоставление.Название) Тогда
		Возврат;	
	КонецЕсли;
	
	Если СопоставлениеЗаполнить.Свойство("КоэффициентСБИС",	СЛокальнаяПеременная) Тогда
		// Коэффициент в новом формате
	КонецЕсли;
	Если ЗначениеЗаполнено(СЛокальнаяПеременная) Тогда
		СопоставлениеДляЕдиницыКлиент_Вставить(ЕдиницаСопоставление, "Коэффициент", СЛокальнаяПеременная);
	КонецЕсли;
	
	СтрокаСопоставленияСБИСКлиент_Вставить(СтрокаСопоставленияСБИС, "Единица", ЕдиницаСопоставление);
	
КонецПроцедуры

&НаСервере
Функция СопоставлениеДляЕдиницыКлиент_ПолучитьПараметрНаСервере(Ссылка, КлючПараметра)
	
	ОбъектПоиска = Ссылка.ПолучитьОбъект();
	Возврат ОбъектПоиска[КлючПараметра];
	
КонецФункции

